name: Create Post from Issue

on:
  issues:
    types:
      - labeled

jobs:
  create_post:
    runs-on: ubuntu-latest
    if: |
      contains(github.event.issue.labels.*.name, 'publish') &&
      github.event.issue.user.login == github.repository_owner

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Create Post File via Python
        id: create_file
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
        run: |
          python3 -c '
          import os
          import re
          import datetime
          import json

          # 1. Get Environment Variables
          title = os.environ.get("ISSUE_TITLE", "Untitled")
          body = os.environ.get("ISSUE_BODY", "")

          # 2. Create Slug (Safe filename)
          # Convert to lowercase, replace non-alphanumeric with hyphen
          slug = title.lower()
          slug = re.sub(r"[^a-z0-9]+", "-", slug).strip("-")
          
          # 3. Create Date String
          date_str = datetime.datetime.now().strftime("%Y-%m-%d")
          
          # 4. Construct Filename
          filename = f"src/content/blog/{date_str}-{slug}.md"
          
          # 5. Sanitize Title for YAML (JSON dumps handles quotes escaping perfectly)
          safe_title = json.dumps(title)

          # 6. Construct File Content
          file_content = f"""---
          title: {safe_title}
          date: "{date_str}"
          description: ""
          tags: []
          ---

          {body}
          """

          # 7. Write File
          with open(filename, "w", encoding="utf-8") as f:
              f.write(file_content)

          print(f"Successfully created: {filename}")
          
          # 8. Set Output for GitHub Actions
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
              gh_out.write(f"filename={filename}\n")
          '

      - name: Commit and Push New Post
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(blog): add post from issue #${{ github.event.issue.number }}"
          file_pattern: "src/content/blog/*.md"

      - name: Close Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              state: 'closed'
            })
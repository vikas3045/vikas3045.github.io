name: Create Post from Issue

on:
  issues:
    types:
      - labeled

jobs:
  create_post:
    runs-on: ubuntu-latest
    # Only run if 'publish' label is added by the repo owner
    if: |
      contains(github.event.issue.labels.*.name, 'publish') &&
      github.event.issue.user.login == github.repository_owner

    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Create Post and Ingest Images
        id: create_file
        env:
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
        run: |
          python3 -c '
          import os, re, datetime, json, requests, uuid

          # 1. Setup Data & Env
          title = os.environ.get("ISSUE_TITLE", "Untitled")
          body = os.environ.get("ISSUE_BODY", "")
          labels = json.loads(os.environ.get("ISSUE_LABELS", "[]"))
          
          # 2. Extract Tags (Filter out "publish")
          tags = [l["name"] for l in labels if l["name"] != "publish"]
          
          # 3. Create Slug and Date
          slug = re.sub(r"[^a-z0-9]+", "-", title.lower()).strip("-")
          date_str = datetime.datetime.now().strftime("%Y-%m-%d")
          
          # 4. Image Ingestion Logic
          # Regex matches GitHub asset/image URLs
          asset_regex = r"https://github\.com/(?:user-attachments/assets|user-images)/[a-zA-Z0-9\-/]+"
          found_urls = re.findall(asset_regex, body)
          
          # Create image directory for this post
          img_rel_dir = f"assets/blog/{slug}"
          img_abs_dir = os.path.join("public", img_rel_dir)
          os.makedirs(img_abs_dir, exist_ok=True)

          for url in found_urls:
              try:
                  print(f"Downloading {url}...")
                  res = requests.get(url, stream=True, timeout=10)
                  if res.status_code == 200:
                      # Determine extension
                      content_type = res.headers.get("Content-Type", "")
                      ext = ".png"
                      if "image/jpeg" in content_type: ext = ".jpg"
                      elif "image/webp" in content_type: ext = ".webp"
                      elif "image/gif" in content_type: ext = ".gif"
                      
                      img_name = f"img-{uuid.uuid4().hex[:8]}{ext}"
                      img_path = os.path.join(img_abs_dir, img_name)
                      
                      with open(img_path, "wb") as f:
                          for chunk in res.iter_content(1024):
                              f.write(chunk)
                      
                      # Replace URL in body with local path for Astro
                      local_url = f"/{img_rel_dir}/{img_name}"
                      body = body.replace(url, local_url)
              except Exception as e:
                  print(f"Failed to ingest {url}: {e}")

          # 5. Construct Markdown File
          filename = f"src/content/blog/{date_str}-{slug}.md"
          # Frontmatter uses json.dumps to handle escaping correctly
          file_content = f"""---
          title: {json.dumps(title)}
          date: "{date_str}"
          description: ""
          tags: {json.dumps(tags)}
          categories: {json.dumps(tags)}
          ---

          {body}
          """

          # 6. Save File
          os.makedirs(os.path.dirname(filename), exist_ok=True)
          with open(filename, "w", encoding="utf-8") as f:
              f.write(file_content)

          # 7. Set Output
          with open(os.environ["GITHUB_OUTPUT"], "a") as gh_out:
              gh_out.write(f"filename={filename}\n")
          '

      - name: Commit and Push New Post and Images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs(blog): add post and images from issue #${{ github.event.issue.number }}"
          # Track both the new markdown and any new images in public/assets/blog
          file_pattern: "src/content/blog/*.md public/assets/blog/**"

      - name: Close Issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ github.event.issue.number }},
              state: 'closed'
            })